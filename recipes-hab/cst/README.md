# CompuLab cst-tools

This is a tool for: signing kernel, imx-boot image and generating the fuse values file inside Yocto.
<br>
This tool uses: [NXP Code Signing Tools](https://www.nxp.com/webapp/Download?colCode=IMX_CST_TOOL_NEW)

Supported machines:
* ucm-imx8m-mini
* mcm-imx8m-mini

# How to use

## Add to the Yocto build
* Clone the layer repository to the ${BUILDIR}/../sources
<pre>
git clone -b imx8 https://github.com/compulab-yokneam/meta-compulab-hab.git ../sources/meta-compulab-hab
</pre>

* Update the conf/bblayrs.conf
<pre>
cat << eof >> conf/bblayrs.conf
BBLAYERS += "\${BSPDIR}/sources/meta-compulab-hab"
eof
</pre>
Being added as a meta-layer, the tool will get created and used **automatically**.

## Manualy signing procedure
In order to build the tool and get the signed files **manually** issue:
<pre>
bitbake -k cst-tools
</pre>

## Output files
* Output Layout
<pre>
cst-tools/
├── ca
│   └── ...
├── crts
│   ├── ...
│   ├── SRK_1_2_3_4_fuse.bin
│   └── SRK_1_2_3_4_table.bin
├── hab
│   ├── csf_additional_images.in
│   ├── csf_fit.in
│   ├── csf_spl.in
│   ├── flash_evk -> imx-boot-mcm-imx8m-mini-sd.bin-flash_evk
│   ├── flash_evk.log
│   ├── Image
│   ├── imx-boot-mcm-imx8m-mini-sd.bin-flash_evk
│   ├── print_fit_hab.log
│   └── signed
│       ├── f
│       │   └── fuse.out -- fuse values
│       ├── k
│       │   ├── csf_additional_images.in
│       │   ├── genivt
│       │   ├── Image
│       │   ├── Image_csf
│       │   ├── Image_pad
│       │   ├── Image_pad_ivt
│       │   ├── ivt.bin
│       │   └── signed -> Image -- signed kernel
│       └── u
│           ├── csf_fit.bin
│           ├── csf_fit.txt
│           ├── csf_spl.bin
│           ├── csf_spl.txt
│           ├── imx-boot-mcm-imx8m-mini-sd.bin-flash_evk
│           └── signed -> imx-boot-mcm-imx8m-mini-sd.bin-flash_evk -- signed imx-boot image
├── keys
│   ├── ...
│   ├── SRK1_sha256_2048_65537_v3_ca_key.der
│   ├── SRK1_sha256_2048_65537_v3_ca_key.pem
│   ├── SRK2_sha256_2048_65537_v3_ca_key.der
│   ├── SRK2_sha256_2048_65537_v3_ca_key.pem
│   ├── SRK3_sha256_2048_65537_v3_ca_key.der
│   ├── SRK3_sha256_2048_65537_v3_ca_key.pem
│   ├── SRK4_sha256_2048_65537_v3_ca_key.der
│   └── SRK4_sha256_2048_65537_v3_ca_key.pem
├── linux64
│   ├── bin
│   │   ├── cst
│   │   └── srktool
│   └── lib
│       └── libfrontend.a
├── Makefile
└── tools
    ├── csf.f
    ├── csf.k
    ├── csf.u
    ├── gen_keys.sh
    ├── gen_srk.sh
    └── hab4_pki_tree.sh
</pre>

* Goto `cst-tools`:
<pre>
cd ${BUILDIR}/tmp/deploy/images/${MACHINE}/cst-tools
</pre>

|Note|The `crts` and the `keys` folders contain keys generated by the latest Yocto build.<br>These forders can be replaced with the keys generated outside Yocto.<br>The `cst-tools` recipe makes use of predefined keys if them are at `crts` and `keys`.|
|---|---|

* Kernel signing
<pre>
make kernel
stat hab/signed/k/Image
</pre>

* imx-boot signing
<pre>
make imx-boot
stat hab/signed/u/imx-boot-mcm-imx8m-mini-sd.bin-flash_evk
</pre>

* fuse values generating
<pre>
make fuse
stat hab/signed/f/fuse.out
</pre>

* Generate all targets `kernel`, `imx-boot`, `fuse` at the same time:
<pre>
make
</pre>

* Clean up

|Description|Command|
|---|---|
| signed files only |make clean|
| keys only |make clean_keys|
| all files |make clean_all|


## Build the image with the user predefined keys
* Copy the user predefined `crts` and the `keys` to `${BUILDIR}/tmp/deploy/images/${MACHINE}/cst-tools` folder:
<pre>
cp -a /path/to/user-predefined/{crts,keys} ${BUILDIR}/tmp/deploy/images/${MACHINE}/cst-tools/
</pre>

* Goto to the ${BUILDIR} directory and rebuild the image:
<pre>
bitbake -k cst-tools -c cleansstate
bitbake -k <image>
</pre>
